<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Mini Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
<h2>ğŸ’¬ ì‹¤ì‹œê°„ ì±„íŒ…</h2>

<div id="chat-box" style="border:1px solid #aaa; height:200px; overflow:auto; margin-bottom:10px;"></div>

<!-- ë©”ì‹œì§€ ì…ë ¥ì°½ -->
<input type="text" id="message" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
<button onclick="sendMessage()">ì „ì†¡</button>

<script>
    let stompClient = null;
    const nickname = "[[${nickname}]]"; // Thymeleaf ì‚¬ìš© ì‹œ ë‹‰ë„¤ì„ì„ ê°€ì ¸ì˜¤ëŠ” ë¶€ë¶„

    // WebSocket ì—°ê²° í•¨ìˆ˜
    function connect() {
        const socket = new SockJS('/ws-chat'); // WebSocket ì—”ë“œí¬ì¸íŠ¸
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);

            // /sub/chat/room ì±„ë„ì„ êµ¬ë…
            stompClient.subscribe('/sub/chat/room', function (messageOutput) {
                const msg = JSON.parse(messageOutput.body);  // ë©”ì‹œì§€ íŒŒì‹±
                showMessage(msg);  // ë©”ì‹œì§€ë¥¼ í™”ë©´ì— í‘œì‹œ
            });

            // ì…ì¥ ë©”ì‹œì§€ ë³´ë‚´ê¸°
            stompClient.send("/app/chat.send", {}, JSON.stringify({
                type: 'JOIN',
                sender: nickname,
                content: ''
            }));
        });
    }

    // ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
    function sendMessage() {
        const content = document.getElementById('message').value;  // ë©”ì‹œì§€ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
        if(content.trim() !== '') {  // ë©”ì‹œì§€ê°€ ë¹„ì–´ìˆì§€ ì•Šìœ¼ë©´
            stompClient.send("/app/chat.send", {}, JSON.stringify({
                type: 'CHAT',  // ì¼ë°˜ ì±„íŒ…
                sender: nickname,
                content: content
            }));
            document.getElementById('message').value = '';  // ì…ë ¥ì°½ ë¹„ìš°ê¸°
        }
    }

    // í™”ë©´ì— ë©”ì‹œì§€ ì¶œë ¥ í•¨ìˆ˜
    function showMessage(msg) {
        const chatBox = document.getElementById('chat-box');
        const line = document.createElement('div');

        // ì…ì¥ ë©”ì‹œì§€ ì²˜ë¦¬
        if (msg.type === 'JOIN') {
            line.innerHTML = `<i>ğŸ‘‹ ${msg.sender} ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤.</i>`;
        }
        // í‡´ì¥ ë©”ì‹œì§€ ì²˜ë¦¬
        else if (msg.type === 'LEAVE') {
            line.innerHTML = `<i>ğŸ‘‹ ${msg.sender} ë‹˜ì´ í‡´ì¥í–ˆìŠµë‹ˆë‹¤.</i>`;
        }
        // ì¼ë°˜ ì±„íŒ… ë©”ì‹œì§€ ì²˜ë¦¬
        else {
            line.textContent = `${msg.sender} : ${msg.content}`;
        }

        chatBox.appendChild(line);  // ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ì¶”ê°€
        chatBox.scrollTop = chatBox.scrollHeight;  // ìµœì‹  ë©”ì‹œì§€ê°€ ë³´ì´ë„ë¡ ìŠ¤í¬ë¡¤ ì´ë™
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ WebSocket ì—°ê²° ì‹œì‘
    connect();
</script>
</body>
</html>
